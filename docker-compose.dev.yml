services:
  stranddb-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
    image: stranddb:dev
    container_name: stranddb-dev
    volumes:
      # Mount source code for hot-reload
      - .:/workspace:cached
      # Cache Cargo registry
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      # Cache target directory (builds)
      - target:/workspace/target
    ports:
      - "7878:7878"   # StrandDB port
      - "9090:9090"   # Metrics port
      - "5678:5678"   # Debug port (for rust-lldb)
    environment:
      - RUST_LOG=debug
      - RUST_BACKTRACE=1
      - CARGO_HOME=/usr/local/cargo
    working_dir: /workspace
    stdin_open: true
    tty: true
    networks:
      - stranddb-dev-network
    command: bash

  # Test database for integration tests
  test-mongodb:
    image: mongo:7.0
    container_name: stranddb-test-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
    volumes:
      - mongodb-data:/data/db
    networks:
      - stranddb-dev-network

  # Test database for benchmarking
  test-postgres:
    image: postgres:16
    container_name: stranddb-test-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=testdb
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - stranddb-dev-network

volumes:
  cargo-registry:
    driver: local
  cargo-git:
    driver: local
  target:
    driver: local
  mongodb-data:
    driver: local
  postgres-data:
    driver: local

networks:
  stranddb-dev-network:
    driver: bridge